<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scientific Nexus | Research Terminal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --cyan: #00f2ff; 
            --purple: #bc13fe; 
            --dark: #050507; 
            --panel: #0f0f13;
            --border: rgba(255,255,255,0.08);
            --header-h: 70px;
            --glass: rgba(15, 15, 19, 0.95);
            --danger: #ff4444;
            --success: #00ff88;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text !important; }

        body { 
            background: var(--dark); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; overflow-x: hidden;
        }

        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease; pointer-events: all;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid rgba(0, 242, 255, 0.2); 
            border-top: 3px solid var(--cyan); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- HEADER --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; background: rgba(5,5,7,0.95); backdrop-filter: blur(10px);
            position: fixed; width: 100%; top: 0; z-index: 1000; border-bottom: 1px solid var(--border);
            height: var(--header-h);
        }
        .logo { 
            font-weight: 800; color: var(--cyan); letter-spacing: 1px; font-size: 1.1rem; 
            text-transform: uppercase; display: flex; align-items: center; gap: 8px; cursor: pointer;
        }
        .auth-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .auth-btn:hover { border-color: var(--cyan); background: rgba(0, 242, 255, 0.1); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--cyan); object-fit: cover; }

        /* --- LAYOUT & ANIMATION FIX --- */
        #app-content { padding-top: var(--header-h); min-height: 100vh; }
        
        .reveal-on-scroll {
            opacity: 0; 
            transform: translateY(50px) scale(0.95);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .reveal-on-scroll.reveal { opacity: 1; transform: translateY(0) scale(1); }

        .hero {
            padding: 60px 20px 40px; text-align: center;
            background: radial-gradient(circle at 50% 0%, #130821 0%, var(--dark) 80%);
        }
        .hero h1 {
            font-size: 2.5rem; margin: 0;
            background: linear-gradient(to right, #fff, var(--cyan)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .controls { max-width: 1200px; margin: 0 auto 30px; padding: 0 20px; }
        .search-bar {
            background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
            padding: 12px 15px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
            transition: 0.3s;
        }
        .search-bar:focus-within { border-color: var(--cyan); box-shadow: 0 0 15px rgba(0,242,255,0.1); }
        .search-bar input { background: transparent; border: none; color: white; width: 100%; font-size: 1rem; }
        
        .categories { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .cat-btn {
            background: #1a1a20; color: #888; border: 1px solid var(--border); padding: 8px 16px; 
            border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 0.9rem; transition: 0.3s;
        }
        .cat-btn.active { background: var(--cyan); color: black; border-color: var(--cyan); font-weight: bold; }

        .grid { 
            display: grid; gap: 15px; padding: 0 20px 50px; max-width: 1200px; margin: 0 auto;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        }
        .card { 
            background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
            cursor: pointer; transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--cyan); }
        .thumb { height: 120px; width: 100%; object-fit: cover; }
        .card-body { padding: 10px; }
        .card-title { margin: 0; font-size: 0.9rem; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card-cat { color: #666; font-size: 0.75rem; margin-top: 4px; display: block;}

        /* --- GAME VIEWER --- */
        #game-viewer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--dark); z-index: 5000; overflow-y: auto;
            display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        #game-viewer.active { opacity: 1; }
        .gv-nav {
            height: 60px; display: flex; align-items: center; padding: 0 20px;
            border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 5001;
        }
        .gv-layout {
            display: grid; grid-template-columns: 180px minmax(300px, 1fr) 180px;
            gap: 20px; max-width: 1600px; margin: 20px auto; padding: 0 20px; align-items: start;
        }
        .gv-sidebar { display: flex; flex-direction: column; gap: 10px; }
        .mini-card {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            background: var(--panel); border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .mini-card:hover { border-color: var(--cyan); background: #1a1a20; }
        .mini-thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }
        .game-frame-wrapper {
            position: relative; width: 100%; padding-top: 56.25%; 
            background: black; border-radius: 12px; overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.1);
        }
        .game-frame-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .fs-btn {
            position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7);
            color: white; border: 1px solid #444; padding: 8px; border-radius: 6px; cursor: pointer;
        }
        @media (max-width: 1024px) {
            .gv-layout { display: flex; flex-direction: column; padding: 0 10px; }
            .gv-sidebar { display: none; } 
        }

        /* --- MODALS & ALERTS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }
        .modal-box { 
            background: #111; padding: 30px; border-radius: 15px; border: 1px solid #333; 
            width: 90%; max-width: 400px; text-align: center; position: relative;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal.active .modal-box { transform: scale(1); }
        .close-modal { position: absolute; top: 10px; right: 15px; color: #666; cursor: pointer; font-size: 1.5rem; }
        .modal-input {
            width: 100%; padding: 12px; background: #000; border: 1px solid #333; 
            color: white; border-radius: 6px; margin-bottom: 10px; font-size: 1rem;
        }
        .action-btn {
            background: var(--cyan); color: black; border: none; padding: 12px; 
            width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- REALISTIC BLOCK MODAL (NEW) --- */
        .alert-box {
            background: linear-gradient(135deg, #220a0a, #000);
            border: 1px solid var(--danger);
            box-shadow: 0 0 40px rgba(255, 68, 68, 0.2);
            position: relative; overflow: hidden;
        }
        .alert-scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--danger);
            animation: scanDown 2s infinite linear;
            opacity: 0.5;
        }
        @keyframes scanDown { 0% { top: 0%; } 100% { top: 100%; } }
        .alert-btns { display: flex; gap: 10px; margin-top: 20px; }
        .alert-btn { flex: 1; padding: 12px; border: 1px solid #444; background: transparent; color: white; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        .alert-btn.confirm { background: rgba(255, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); }
        .alert-btn.confirm:hover { background: var(--danger); color: black; }
        .alert-btn.cancel:hover { background: #333; }

        /* --- SOCIAL HUB --- */
        #social-fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px; background: var(--panel); border: 2px solid var(--cyan);
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            color: var(--cyan); font-size: 1.5rem; cursor: pointer; z-index: 4000;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); transition: 0.3s;
        }
        #social-panel {
            position: fixed; bottom: 90px; right: 20px; width: 340px; height: 500px;
            background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(0, 242, 255, 0.3);
            border-radius: 15px; z-index: 3999; transform: translateX(130%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: -5px 5px 20px rgba(0,0,0,0.5);
        }
        #social-panel.active { transform: translateX(0); }
        
        .social-tabs { display: flex; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: #666; cursor: pointer; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--cyan); border-bottom-color: var(--cyan); background: rgba(0, 242, 255, 0.05); }

        .social-body { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); }
        .social-view { display: none; padding: 0; }
        .social-view.active { display: block; }
        
        .friend-item {
            display: flex; align-items: center; gap: 10px; padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s;
        }
        .friend-item:hover { background: rgba(255,255,255,0.05); }
        .f-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; transition: 0.3s; }
        .status-dot.online { background: #0f0; box-shadow: 0 0 8px #0f0; }
        .status-dot.offline { background: #555; }

        /* --- CHAT --- */
        #chat-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); z-index: 50; display: flex; flex-direction: column;
            transform: translateX(100%); transition: 0.3s ease;
        }
        #chat-interface.open { transform: translateX(0); }
        
        .chat-header {
            padding: 10px 15px; background: var(--panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; word-wrap: break-word; position: relative; }
        .msg.mine { align-self: flex-end; background: var(--cyan); color: black; border-bottom-right-radius: 2px; }
        .msg.theirs { align-self: flex-start; background: #222; color: white; border-bottom-left-radius: 2px; }
        
        /* CHAT STATUS INDICATOR (NEW) */
        .msg-status-dot {
            width: 6px; height: 6px; border-radius: 50%; position: absolute; bottom: 2px; right: -10px;
            transition: background 0.3s;
        }
        .msg-status-dot.sending { background: var(--danger); box-shadow: 0 0 5px var(--danger); animation: pulseRed 1s infinite; }
        .msg-status-dot.sent { background: #0088ff; box-shadow: 0 0 5px #0088ff; }
        @keyframes pulseRed { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .chat-input-area { padding: 10px; background: var(--panel); display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 20px; }

        .friend-btn {
            background: transparent; border: 1px solid #333; color: #888;
            width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .friend-btn.accept { color: var(--success); border-color: var(--success); }
        .friend-btn.reject { color: var(--danger); border-color: var(--danger); }

    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>

<nav>
    <div class="logo" onclick="goHome()">
        <i class="fas fa-atom"></i> <span style="margin-left:8px;">SCIENTIFIC NEXUS</span>
    </div>
    <div class="user-nav" id="auth-container"></div>
</nav>

<div id="app-content">
    <div class="hero reveal-on-scroll">
        <h1>RESEARCH TERMINAL</h1>
        <p style="color:#888; font-size:0.95rem;">Advanced physics simulations & tactical modules.</p>
    </div>

    <div class="controls reveal-on-scroll">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search modules..." onkeyup="filterGames()">
        </div>
        <div class="categories">
            <button class="cat-btn active" onclick="filterCat('All')">All</button>
            <button class="cat-btn" onclick="filterCat('Arcade')">Arcade</button>
            <button class="cat-btn" onclick="filterCat('Puzzle')">Puzzle</button>
            <button class="cat-btn" onclick="filterCat('Physics')">Physics</button>
        </div>
    </div>

    <div class="grid" id="game-grid"></div>
</div>

<div id="game-viewer">
    <div class="gv-nav">
        <button onclick="closeGame()" style="background:none; border:none; color:white; font-size:1.1rem; cursor:pointer;">
            <i class="fas fa-arrow-left"></i> EXIT
        </button>
    </div>
    <div class="gv-layout">
        <div class="gv-sidebar" id="sidebar-left"></div>
        <div class="gv-stage">
            <div class="game-frame-wrapper" id="gf-wrapper">
                <iframe id="game-frame" allowfullscreen></iframe>
                <button class="fs-btn" onclick="toggleFull()"><i class="fas fa-expand"></i></button>
            </div>
            <div class="game-meta">
                <h2 id="gv-title" style="margin:0; color:white;">Game Title</h2>
                <div style="margin-top:5px; color:#888;">SCIENTIFIC SIMULATION</div>
            </div>
        </div>
        <div class="gv-sidebar" id="sidebar-right"></div>
    </div>
</div>

<div id="social-fab" onclick="toggleSocialPanel()">
    <i class="fas fa-user-friends"></i>
    <div style="position:absolute; top:-5px; right:-5px; background:#ff4444; color:white; width:20px; height:20px; border-radius:50%; font-size:0.7rem; display:none; align-items:center; justify-content:center;" id="req-badge"></div>
</div>

<div id="social-panel">
    <div id="chat-interface">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:10px; color:var(--cyan); font-weight:bold;">
                <button onclick="closeChat()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <span id="chat-friend-name">Friend</span>
            </div>
            <button onclick="openBlockModal()" style="background:none; border:none; color:#666; cursor:pointer;"><i class="fas fa-ban"></i></button>
        </div>
        <div class="chat-messages" id="chat-msgs"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Message..." onkeypress="handleChatKey(event)">
            <button onclick="sendMessage()" style="background:var(--cyan); border:none; width:35px; height:35px; border-radius:50%; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="social-tabs">
        <button class="tab-btn active" onclick="switchTab('friends')">ALLIES</button>
        <button class="tab-btn" onclick="switchTab('comms')">COMMS</button>
        <button class="tab-btn" onclick="switchTab('blocked')" style="color:#ff6666;">RESTRICTED</button>
    </div>

    <div class="social-body">
        <div id="view-friends" class="social-view active">
            <div id="friends-list" style="padding-bottom:20px;"></div>
        </div>

        <div id="view-comms" class="social-view">
            <div style="padding:10px; font-size:0.75rem; color:#888; text-transform:uppercase;">Incoming</div>
            <div id="requests-list"></div>
            
            <div style="padding:10px; font-size:0.75rem; color:#888; text-transform:uppercase; margin-top:10px;">Establish Link</div>
            <div style="padding:15px;">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="invite-input-tab" class="modal-input" placeholder="Enter 8-Digit ID" maxlength="16" style="margin:0; text-align:center; font-family:monospace; letter-spacing:1px;">
                    <button onclick="sendInvite()" style="background:var(--cyan); border:none; border-radius:6px; width:40px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
                </div>
                <p id="invite-msg-tab" style="font-size:0.8rem; margin-top:8px; text-align:center; min-height:1.2em;"></p>
                <div style="margin-top:20px; text-align:center;">
                    <div style="font-size:0.75rem; color:#666; margin-bottom:5px;">YOUR ID</div>
                    <div id="my-code-display" style="font-family:monospace; color:var(--cyan); border:1px dashed #333; padding:5px; font-size:1rem; letter-spacing:1px; cursor:pointer;" onclick="copyCode(this.innerText)">Generating...</div>
                </div>
            </div>
        </div>

        <div id="view-blocked" class="social-view">
            <div id="blocked-list" style="padding:10px;"></div>
        </div>
    </div>
</div>

<div id="block-confirm-modal" class="modal">
    <div class="modal-box alert-box">
        <div class="alert-scan-line"></div>
        <h2 style="color:var(--danger); text-transform:uppercase; letter-spacing:2px; margin-top:0;">
            <i class="fas fa-exclamation-triangle"></i> Protocol Alert
        </h2>
        <p style="color:#ccc; font-size:0.9rem;">
            Initiating severance protocol for target entity. <br>
            Communication channels will be terminated.
        </p>
        <div class="alert-btns">
            <button class="alert-btn cancel" onclick="closeModal('block-confirm-modal')">Abort</button>
            <button class="alert-btn confirm" onclick="confirmBlockUser()">Execute Block</button>
        </div>
    </div>
</div>

<div id="unblock-confirm-modal" class="modal">
    <div class="modal-box alert-box" style="border-color:var(--cyan); box-shadow:0 0 30px rgba(0,242,255,0.1);">
        <div class="alert-scan-line" style="background:var(--cyan);"></div>
        <h2 style="color:var(--cyan); text-transform:uppercase; letter-spacing:2px; margin-top:0;">
            <i class="fas fa-shield-alt"></i> Restore Link
        </h2>
        <p style="color:#ccc; font-size:0.9rem;">
            Re-establishing neural handshake with restricted entity.<br>
            Are you sure you wish to proceed?
        </p>
        <div class="alert-btns">
            <button class="alert-btn cancel" onclick="closeModal('unblock-confirm-modal')">Cancel</button>
            <button class="alert-btn" style="border-color:var(--cyan); color:var(--cyan);" onclick="confirmUnblockUser()">Restore</button>
        </div>
    </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-box">
        <span class="close-modal" onclick="closeModal('login-modal')">Ã—</span>
        <h2 style="color:white; margin-top:0;">Identity Verify</h2>
        <button onclick="loginGoogle()" style="background:white; color:black; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>
</div>

<div id="username-modal" class="modal" style="z-index: 6001;">
    <div class="modal-box">
        <h2 style="color:var(--cyan); margin-top:0;">Establish Alias</h2>
        <input type="text" id="new-username" class="modal-input" placeholder="e.g. NeoOne" maxlength="10">
        <p id="username-error" style="color:#ff4444; font-size:0.8rem; display:none;"></p>
        <button id="submit-btn" onclick="submitUsername()" class="action-btn">CONFIRM IDENTITY</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCrgwoD_IVwlyvUQwDDQj6T772obSOL8So",
        authDomain: "scientificnexus-65c48.firebaseapp.com",
        projectId: "scientificnexus-65c48",
        storageBucket: "scientificnexus-65c48.firebasestorage.app",
        messagingSenderId: "125907587809",
        appId: "1:125907587809:web:d8068604db659fa357dda0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Enable offline persistence for faster loads
    db.enablePersistence().catch(err => console.log(err));

    let currentUser = null;
    let userData = null;
    let activeChatId = null;
    let currentChatUserUid = null;
    let targetUnblockUid = null; // For modal
    let chatUnsub = null;
    let friendStatusUnsubs = [];

    const gameData = [
        { title: "Paper.io 2", cat: "Arcade", url: "https://paper-io.com/", thumb: "https://img.poki.com/cdn-cgi/image/quality=78,width=600,height=600,fit=cover,f=auto/d2708e8aa31df3fe7b211bca2347cb56.png" },
        { title: "Fluid Sim", cat: "Physics", url: "https://paveldogreat.github.io/WebGL-Fluid-Simulation/", thumb: "https://store-images.s-microsoft.com/image/apps.4394.13510798887593933.91e84e56-11f8-4354-94b1-84196d421259.0d2a842f-871d-4876-b333-e9687e14f6b4?mode=scale&q=90&h=300&w=300" },
        { title: "Hextris", cat: "Puzzle", url: "https://hextris.io/", thumb: "https://raw.githubusercontent.com/hextris/hextris/gh-pages/images/icons/apple-touch-icon-144x144.png" },
        { title: "Pacman", cat: "Arcade", url: "https://freepacman.org/", thumb: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Pacman.svg/1200px-Pacman.svg.png" },
        { title: "Dino Run", cat: "Arcade", url: "https://chromedino.com/", thumb: "https://img.poki.com/cdn-cgi/image/quality=78,width=600,height=600,fit=cover,f=auto/96b825227702f23246f6580556209428.png" },
        { title: "Solitaire", cat: "Puzzle", url: "https://www.google.com/logos/fnbx/solitaire/standalone.html", thumb: "https://img.poki.com/cdn-cgi/image/quality=78,width=600,height=600,fit=cover,f=auto/8e448b11678d42d62734157e934a3788.png" }
    ];

    function render() {
        const grid = document.getElementById('game-grid');
        const sidebarL = document.getElementById('sidebar-left');
        const sidebarR = document.getElementById('sidebar-right');
        
        grid.innerHTML = '';
        if(sidebarL) sidebarL.innerHTML = '<h3 style="color:var(--cyan); margin:0 0 10px;">Trending</h3>';
        if(sidebarR) sidebarR.innerHTML = '<h3 style="color:var(--purple); margin:0 0 10px;">New</h3>';

        gameData.forEach((g, i) => {
            grid.appendChild(createCard(g));
            const mini = createMini(g);
            if (i < 3 && sidebarL) sidebarL.appendChild(mini.cloneNode(true));
            else if (i < 6 && sidebarR) sidebarR.appendChild(mini.cloneNode(true));
        });
        observeElements();
    }

    function createCard(g) {
        const div = document.createElement('div');
        div.className = 'card reveal-on-scroll';
        div.innerHTML = `<img src="${g.thumb}" class="thumb"><div class="card-body"><h3 class="card-title">${g.title}</h3><span class="card-cat">${g.cat}</span></div>`;
        div.onclick = () => openGame(g.url, g.title, g.cat);
        return div;
    }

    function createMini(g) {
        const div = document.createElement('div');
        div.className = 'mini-card';
        div.innerHTML = `<img src="${g.thumb}" class="mini-thumb"><div class="mini-title">${g.title}</div>`;
        div.onclick = () => openGame(g.url, g.title, g.cat);
        return div;
    }

    // --- SCROLL ANIMATION FIX ---
    function observeElements() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('reveal');
                } else {
                    // Reset class to allow it to animate again when scrolling back
                    entry.target.classList.remove('reveal');
                }
            });
        }, { threshold: 0.1 }); // Trigger when 10% visible
        document.querySelectorAll('.reveal-on-scroll').forEach(el => observer.observe(el));
    }

    function openLoginModal() { document.getElementById('login-modal').classList.add('active'); }
    function loginGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).then(() => closeModal('login-modal')); }
    
    auth.onAuthStateChanged(user => {
        currentUser = user;
        const container = document.getElementById('auth-container');
        if (user) {
            container.innerHTML = `<button class="auth-btn" style="border-color:var(--cyan);" onclick="auth.signOut().then(()=>window.location.reload())"><img src="${user.photoURL}" class="user-avatar"> LOGOUT</button>`;
            document.getElementById('social-fab').style.display = 'flex';
            
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if(doc.exists) {
                    userData = doc.data();
                    if(!userData.username) document.getElementById('username-modal').classList.add('active');
                    else {
                        if(!userData.commanderId) generateAndSaveId();
                        else document.getElementById('my-code-display').innerText = userData.commanderId;
                        loadSocialData();
                        startHeartbeat();
                    }
                } else {
                    document.getElementById('username-modal').classList.add('active');
                }
            });
        } else {
            container.innerHTML = `<button class="auth-btn" onclick="openLoginModal()"><i class="fas fa-sign-in-alt"></i> LOGIN</button>`;
            document.getElementById('social-fab').style.display = 'none';
        }
    });

    async function submitUsername() {
        const val = document.getElementById('new-username').value.trim();
        const err = document.getElementById('username-error');
        if(val.length < 3) { err.innerText = "Too short."; err.style.display='block'; return; }
        
        try {
            const check = await db.collection('usernames').doc(val).get();
            if(check.exists) { err.innerText = "Taken."; err.style.display='block'; return; }
            
            const batch = db.batch();
            const cid = Math.floor(10000000 + Math.random() * 90000000).toString();
            batch.set(db.collection('usernames').doc(val), { uid: currentUser.uid });
            batch.set(db.collection('users').doc(currentUser.uid), { username: val, commanderId: cid, friends: [], blocked: [], joined: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            batch.set(db.collection('friend_codes').doc(cid), { uid: currentUser.uid, username: val });
            await batch.commit();
            document.getElementById('username-modal').classList.remove('active');
        } catch(e) { err.innerText = e.message; err.style.display='block'; }
    }

    function generateAndSaveId() {
        const cid = Math.floor(10000000 + Math.random() * 90000000).toString();
        const batch = db.batch();
        batch.update(db.collection('users').doc(currentUser.uid), { commanderId: cid });
        batch.set(db.collection('friend_codes').doc(cid), { uid: currentUser.uid, username: userData.username });
        batch.commit();
    }

    // --- SOCIAL & STATUS LOGIC ---
    function loadSocialData() {
        db.collection('friend_requests').where('toUid', '==', currentUser.uid).onSnapshot(snap => {
            const list = document.getElementById('requests-list');
            const badge = document.getElementById('req-badge');
            list.innerHTML = snap.empty ? '<div style="text-align:center; padding:10px; font-style:italic;">No signals.</div>' : '';
            badge.style.display = snap.empty ? 'none' : 'flex';
            badge.innerText = snap.size;
            
            snap.forEach(doc => {
                const d = doc.data();
                const div = document.createElement('div');
                div.className = 'friend-item';
                div.innerHTML = `<div style="flex:1;"><b>${d.fromName}</b><br><small>Requesting access</small></div>
                <button onclick="acceptRequest('${doc.id}', '${d.fromUid}', '${d.fromName}')" class="friend-btn accept"><i class="fas fa-check"></i></button>
                <button onclick="rejectRequest('${doc.id}')" class="friend-btn reject"><i class="fas fa-times"></i></button>`;
                list.appendChild(div);
            });
        });

        renderFriends(userData.friends || []);
        renderBlocked(userData.blocked || []);
    }

    function renderFriends(arr) {
        const list = document.getElementById('friends-list');
        list.innerHTML = '';
        friendStatusUnsubs.forEach(u => u());
        friendStatusUnsubs = [];

        if(arr.length === 0) { list.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">No allies connected.</div>'; return; }

        arr.forEach(f => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.innerHTML = `
                <img src="https://ui-avatars.com/api/?name=${f.username}&background=random" class="f-avatar">
                <div style="flex:1;">
                    <div style="font-weight:bold;">${f.username}</div>
                    <div style="font-size:0.75rem; color:#888;" id="status-${f.uid}"><span class="status-dot offline"></span> Offline</div>
                </div>
                <i class="far fa-comment-alt" style="opacity:0.5"></i>
            `;
            div.onclick = () => openChat(f.uid, f.username);
            list.appendChild(div);
            
            // Live Status Listener
            const sub = db.collection('users').doc(f.uid).onSnapshot(d => {
                if(d.exists) {
                    const last = d.data().lastSeen;
                    const el = document.getElementById(`status-${f.uid}`);
                    if(!el) return;
                    // Check if lastSeen is a Timestamp object or number
                    const lastTime = last && last.toMillis ? last.toMillis() : (last || 0);
                    const isOnline = (Date.now() - lastTime) < 60000; // 60s threshold
                    el.innerHTML = isOnline ? 
                        `<span class="status-dot online"></span> <span style="color:#00ff88">Active</span>` : 
                        `<span class="status-dot offline"></span> Offline`;
                }
            });
            friendStatusUnsubs.push(sub);
        });
    }

    // --- HEARTBEAT FIX (USE SERVER TIMESTAMP) ---
    function startHeartbeat() {
        const beat = () => {
            if(currentUser) db.collection("users").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
        };
        beat();
        setInterval(beat, 30000); // 30 seconds for accuracy
    }

    // --- INVITE FIX (INSTANT) ---
    async function sendInvite() {
        const code = document.getElementById('invite-input-tab').value.trim();
        const msg = document.getElementById('invite-msg-tab');
        if(code.length < 5) { msg.innerText = "Invalid ID."; msg.style.color = 'red'; return; }
        
        msg.innerText = "Transmitting..."; msg.style.color = 'var(--cyan)';
        
        try {
            // Direct query, no timeout wrapper needed
            const doc = await db.collection('friend_codes').doc(code).get();
            if(!doc.exists) throw new Error("ID not found.");
            
            const targetUid = doc.data().uid;
            if(targetUid === currentUser.uid) throw new Error("Cannot invite self.");
            
            // Check existing
            if(userData.friends.find(f => f.uid === targetUid)) throw new Error("Already allies.");
            
            await db.collection('friend_requests').add({
                fromUid: currentUser.uid, fromName: userData.username, toUid: targetUid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            msg.innerText = "Signal Sent."; msg.style.color = 'var(--success)';
            document.getElementById('invite-input-tab').value = '';
        } catch(e) {
            msg.innerText = e.message; msg.style.color = 'red';
        }
    }

    // --- FRIEND ACCEPT FIX (TWO WAY SYNC) ---
    async function acceptRequest(rid, uid, name) {
        try {
            const batch = db.batch();
            const meRef = db.collection('users').doc(currentUser.uid);
            const themRef = db.collection('users').doc(uid);
            const reqRef = db.collection('friend_requests').doc(rid);

            // Update ME
            batch.update(meRef, { 
                friends: firebase.firestore.FieldValue.arrayUnion({ uid: uid, username: name }) 
            });
            // Update THEM (Rules must allow this, see provided rules)
            batch.update(themRef, { 
                friends: firebase.firestore.FieldValue.arrayUnion({ uid: currentUser.uid, username: userData.username }) 
            });
            // Delete Request
            batch.delete(reqRef);

            await batch.commit();
        } catch(e) { alert("Link Error: " + e.message); }
    }

    function rejectRequest(rid) { db.collection('friend_requests').doc(rid).delete(); }

    // --- CHAT WITH RED/BLUE INDICATORS ---
    function openChat(uid, name) {
        currentChatUserUid = uid;
        document.getElementById('chat-friend-name').innerText = name;
        document.getElementById('chat-interface').classList.add('open');
        activeChatId = [currentUser.uid, uid].sort().join('_');
        const box = document.getElementById('chat-msgs');
        box.innerHTML = '';
        
        if(chatUnsub) chatUnsub();
        chatUnsub = db.collection('chats').doc(activeChatId).collection('messages')
            .orderBy('timestamp', 'asc').limit(50)
            .onSnapshot(snap => {
                box.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = `msg ${d.senderId === currentUser.uid ? 'mine' : 'theirs'}`;
                    el.innerText = d.text;
                    // For my messages, show Blue dot if it came from DB (meaning it's saved)
                    if(d.senderId === currentUser.uid) {
                        const dot = document.createElement('div');
                        dot.className = 'msg-status-dot sent'; // Blue
                        el.appendChild(dot);
                    }
                    box.appendChild(el);
                });
                box.scrollTop = box.scrollHeight;
            });
    }

    async function sendMessage() {
        const inp = document.getElementById('chat-input');
        const txt = inp.value.trim();
        if(!txt || !activeChatId) return;

        // 1. Show Instant Feedback (Red Dot)
        const box = document.getElementById('chat-msgs');
        const tempId = 'temp-' + Date.now();
        const el = document.createElement('div');
        el.className = 'msg mine';
        el.innerText = txt;
        el.id = tempId;
        el.innerHTML += `<div class="msg-status-dot sending"></div>`; // Red pulsing
        box.appendChild(el);
        box.scrollTop = box.scrollHeight;
        inp.value = '';

        try {
            await db.collection('chats').doc(activeChatId).collection('messages').add({
                text: txt, senderId: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            // Database writes 'participants' to ensure rules work
            db.collection('chats').doc(activeChatId).set({ participants: activeChatId.split('_') }, { merge: true });
            
            // The onSnapshot will replace the temp message with the real one (Blue dot)
            // But just in case of lag, we remove temp
            const tempEl = document.getElementById(tempId);
            if(tempEl) tempEl.remove(); 
        } catch(e) {
            console.error(e);
            alert("Transmission Failed");
        }
    }
    function handleChatKey(e) { if(e.key === 'Enter') sendMessage(); }
    function closeChat() { 
        document.getElementById('chat-interface').classList.remove('open'); 
        if(chatUnsub) chatUnsub();
    }

    // --- BLOCKING (REALISTIC MODAL) ---
    function openBlockModal() { document.getElementById('block-confirm-modal').classList.add('active'); }
    
    async function confirmBlockUser() {
        if(!currentChatUserUid) return;
        const name = document.getElementById('chat-friend-name').innerText;
        const batch = db.batch();
        batch.update(db.collection('users').doc(currentUser.uid), {
            friends: firebase.firestore.FieldValue.arrayRemove({ uid: currentChatUserUid, username: name }),
            blocked: firebase.firestore.FieldValue.arrayUnion({ uid: currentChatUserUid, username: name })
        });
        await batch.commit();
        closeModal('block-confirm-modal');
        closeChat();
        switchTab('blocked');
    }

    function renderBlocked(arr) {
        const list = document.getElementById('blocked-list');
        list.innerHTML = arr.length ? '' : '<div style="text-align:center; color:#666; margin-top:20px;">No restricted entities.</div>';
        arr.forEach(b => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.innerHTML = `<i class="fas fa-ban" style="color:#666; margin-right:10px;"></i>
                <div style="flex:1;"><b>${b.username}</b><br><small>Restricted</small></div>
                <button class="friend-btn" style="color:var(--cyan); border-color:var(--cyan); width:auto; padding:0 10px;" onclick="openUnblockModal('${b.uid}')">RESTORE</button>`;
            list.appendChild(div);
        });
    }

    // --- UNBLOCK (REALISTIC MODAL) ---
    function openUnblockModal(uid) {
        targetUnblockUid = uid;
        document.getElementById('unblock-confirm-modal').classList.add('active');
    }

    async function confirmUnblockUser() {
        if(!targetUnblockUid) return;
        const obj = userData.blocked.find(b => b.uid === targetUnblockUid);
        if(obj) {
            await db.collection('users').doc(currentUser.uid).update({
                blocked: firebase.firestore.FieldValue.arrayRemove(obj)
            });
        }
        closeModal('unblock-confirm-modal');
    }

    // --- UTILS ---
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function toggleSocialPanel() { document.getElementById('social-panel').classList.toggle('active'); }
    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', ['friends','comms','blocked'][i] === t));
        document.querySelectorAll('.social-view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
    }
    function copyCode(c) { navigator.clipboard.writeText(c); alert("ID Copied"); }
    function filterCat(c) { 
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        (c === 'All' ? gameData : gameData.filter(g => g.cat === c)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    }
    function filterGames() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        gameData.filter(g => g.title.toLowerCase().includes(q)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    }
    function openGame(u, t, c) {
        const v = document.getElementById('game-viewer'); v.style.display = 'block'; 
        setTimeout(() => v.classList.add('active'), 10);
        document.getElementById('game-frame').src = u;
        document.getElementById('gv-title').innerText = t;
    }
    function closeGame() {
        const v = document.getElementById('game-viewer'); v.classList.remove('active');
        setTimeout(() => { v.style.display = 'none'; document.getElementById('game-frame').src = ''; }, 300);
    }
    function toggleFull() { 
        const e = document.getElementById('gf-wrapper'); 
        !document.fullscreenElement ? e.requestFullscreen() : document.exitFullscreen(); 
    }
    function goHome() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    window.onload = () => { document.getElementById('loader').style.opacity = '0'; setTimeout(()=>document.getElementById('loader').style.display='none',500); render(); };
</script>
</body>
</html>